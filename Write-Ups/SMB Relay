Description: The analyst identified services and protocols that are misconfigured for many hosts in the network. The network poses a large security risk in its current state due to how damaging the abuse of this technique is. The analyst was able to create and persist multiple connections with the state and parameters of said hijacked user. The analyst was able to hijack and route sessions around the network at will. This grants an attacker the ability to remotely execute code, change the user’s password, connect to SMB shares, and issue commands remotely to other hosts in the network.

Insecurities in NTLM Authentication have been known about for over 15 years. The protocol can be abused to hijack a victim’s session through a process called “relaying,” which abuses a victim’s credentials by forwarding them to a different service than intended. It is important to note that NTLM authentication is still supported and enabled by default in many cases even though it has been replaced as default authentication method by the more secure Kerberos.

Remediation:  The only complete mitigation and defense against this attack is to disable NTLM entirely and switch to Kerberos. In cases where the organization relies on NTLM, due to legacy products or operating systems that do not support Kerberos, several settings exist that can be enabled to minimize the risk of relaying. These settings are outlined below.

•	Enable SMB signing SMB signing will prevent relaying to SMB by requiring all traffic to be signed. Signing requires the user password to authenticate the messages, and thus an attacker relaying the connection cannot send any traffic that will be accepted by the server, since the attacker does not possess the victim’s password.
•	Enable LDAP signing: Similar to SMB signing, LDAP signing prevents unsigned connections to LDAP. It should be noted that connections to LDAP that happen over TLS are considered signed, so this setting will not prevent relay attacks to LDAP over TLS.
•	Enable extended protection for authentication: Extended protection for authentication helps prevent some relaying attacks by ensuring that the TLS channel used for the connection to the server is the same that the client uses when authenticating. This setting mainly applies to IIS.
•	Enable SPN target name validation: SPN target name validation is another measure which prevents relaying to SMB by validating the target name to which the client thinks it is authenticating. If the name does not match with the server, the authentication is refused.
•	Ensure internal websites use HTTPS: When internal websites are visited over the insecure HTTP protocol, there is no possible way for users to validate the authenticity of the connection. By enforcing all internal websites to only function over HTTPS, relaying becomes much less effective.
Aside from these specific server-side measurements, the following general hardening can help prevent NTLM relaying:
•	Disable automatic intranet detection: If NTLM authentication is required in the domain, make sure that browsers (mainly Internet Explorer) only automatically authenticate to trusted websites. Via Group Policy it is possible to disable automatic intranet detection and only automatically authenticate to a whitelist of internal websites to which automatic authentication should apply. As mentioned previously, it is strongly recommended to only use HTTPS websites here.
•	Disable Windows Proxy Auto Detection: While the security issues of WPAD have been mostly addressed by the Microsoft MS16-077 security update, it is still recommended to disable WPAD in general via Group Policy.
•	Disable LLMNR/NBNS: These insecure name resolution protocols are often not required in well configured networks. Disabling them gives an attacker fewer possibilities for name resolution spoofing, which in turn makes it harder for attackers to trick victims in connecting to the attacker’s server.
